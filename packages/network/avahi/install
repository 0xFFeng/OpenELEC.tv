#!/bin/sh

################################################################################
#      This file is part of OpenELEC - http://www.openelec.tv
#      Copyright (C) 2009-2011 Stephan Raue (stephan@openelec.tv)
#
#  This Program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2, or (at your option)
#  any later version.
#
#  This Program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with OpenELEC.tv; see the file COPYING.  If not, write to
#  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
#  http://www.gnu.org/copyleft/gpl.html
################################################################################

. config/options $1

PYTHON_LIB_DIR=`ls -d $INSTALL_SYSTEM/lib/python*`

add_user avahi x 495 495 "avahi-daemon" "/var/run/avahi-daemon" "/bin/sh"
add_group avahi 495

add_user avahiautoipd x 496 496 "avahi-autoipd" "/var/lib/avahi-autoipd" "/bin/sh"
add_group avahiautoipd 496

mkdir -p $INSTALL_SYSTEM/etc/avahi
  cp $PKG_BUILD/avahi-autoipd/avahi-autoipd.action $INSTALL_SYSTEM/etc/avahi
  cp $PKG_BUILD/avahi-daemon/avahi-daemon.conf $INSTALL_SYSTEM/etc/avahi
  cp $PKG_BUILD/avahi-dnsconfd/avahi-dnsconfd.action $INSTALL_SYSTEM/etc/avahi
  cp $PKG_BUILD/avahi-daemon/hosts $INSTALL_SYSTEM/etc/avahi

mkdir -p $INSTALL_SYSTEM/etc/avahi/services
  cp $PKG_BUILD/avahi-daemon/ssh.service $INSTALL_SYSTEM/etc/avahi/services
  cp $PKG_DIR/config/http.service $INSTALL_SYSTEM/etc/avahi/services
#  cp $PKG_DIR/config/samba.service $INSTALL_SYSTEM/etc/avahi/services

  if [ $SFTP_SERVER = "yes" ]; then
    cp $PKG_BUILD/avahi-daemon/sftp-ssh.service $INSTALL_SYSTEM/etc/avahi/services
  fi

mkdir -p $INSTALL_SYSTEM/etc/dbus-1/system.d
  cp $PKG_BUILD/avahi-daemon/avahi-dbus.conf $INSTALL_SYSTEM/etc/dbus-1/system.d

mkdir -p $INSTALL_SYSTEM/bin
  cp $PKG_BUILD/avahi-utils/.libs/avahi-browse $INSTALL_SYSTEM/bin
    ln -sf avahi-browse $INSTALL_SYSTEM/bin/avahi-browse-domains
  cp $PKG_BUILD/avahi-utils/.libs/avahi-publish $INSTALL_SYSTEM/bin
    ln -sf avahi-publish $INSTALL_SYSTEM/bin/avahi-publish-address
    ln -sf avahi-publish $INSTALL_SYSTEM/bin/avahi-publish-service
  cp $PKG_BUILD/avahi-utils/.libs/avahi-resolve $INSTALL_SYSTEM/bin
    ln -sf avahi-resolve $INSTALL_SYSTEM/bin/avahi-resolve-address
    ln -sf avahi-resolve $INSTALL_SYSTEM/bin/avahi-resolve-host-name
  cp $PKG_BUILD/avahi-utils/.libs/avahi-set-host-name $INSTALL_SYSTEM/bin

mkdir -p $INSTALL_SYSTEM/sbin
  cp $PKG_BUILD/avahi-autoipd/avahi-autoipd $INSTALL_SYSTEM/sbin
  cp $PKG_BUILD/avahi-daemon/.libs/avahi-daemon $INSTALL_SYSTEM/sbin
  cp $PKG_BUILD/avahi-dnsconfd/.libs/avahi-dnsconfd $INSTALL_SYSTEM/sbin

mkdir -p $INSTALL_SYSTEM/lib
  cp -P $PKG_BUILD/avahi-common/.libs/*.so*[.0-9] $INSTALL_SYSTEM/lib/
  cp -P $PKG_BUILD/avahi-core/.libs/*.so*[.0-9] $INSTALL_SYSTEM/lib/
  cp -P $PKG_BUILD/avahi-client/.libs/*.so*[.0-9] $INSTALL_SYSTEM/lib/
  cp -P $PKG_BUILD/avahi-compat-libdns_sd/.libs/*.so*[.0-9] $INSTALL_SYSTEM/lib/

mkdir -p $PYTHON_LIB_DIR/site-packages/avahi
  cp -P $PKG_BUILD/avahi-python/avahi/*.py $PYTHON_LIB_DIR/site-packages/avahi

mkdir -p $INSTALL_SYSTEM/share/avahi
  cp $PKG_BUILD/service-type-database/service-types $INSTALL_SYSTEM/share/avahi
  cp $PKG_BUILD/avahi-daemon/avahi-service.dtd $INSTALL_SYSTEM/share/avahi

mkdir -p $INSTALL_SYSTEM/share/dbus-1/interfaces
  cp $PKG_BUILD/avahi-daemon/org.freedesktop.Avahi.*.xml $INSTALL_SYSTEM/share/dbus-1/interfaces

