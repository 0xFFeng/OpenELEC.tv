#!/bin/sh

################################################################################
#      This file is part of OpenELEC - http://www.openelec.tv
#      Copyright (C) 2009-2011 Stephan Raue (stephan@openelec.tv)
#
#  This Program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2, or (at your option)
#  any later version.
#
#  This Program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with OpenELEC.tv; see the file COPYING.  If not, write to
#  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
#  http://www.gnu.org/copyleft/gpl.html
################################################################################

. config/options $1

ROOT_PWD="`$ROOT/$TOOLCHAIN/bin/cryptpw -m sha512 $ROOT_PASSWORD`"
USER_PWD="`$ROOT/$TOOLCHAIN/bin/cryptpw -m sha512 $USER_PASSWORD`"

  add_user root "$ROOT_PWD" 0 0 "Root User" "/storage" "/bin/sh"
  add_group root 0
  add_group users 100

  add_user $USER_NAME "$USER_PWD" 1000 1000 "User" "/storage" "/bin/sh"
  add_group $USER_GROUP 1000

  cp -PR $BUILD/busybox*/_install-system/* $INSTALL_ROOT
    echo "chmod 4755 $INSTALL_ROOT/bin/busybox" >> $FAKEROOT_SCRIPT

  mkdir -p $INSTALL_ROOT
    cp $PKG_DIR/scripts/init $INSTALL_ROOT

  mkdir -p $INSTALL_ROOT/etc
    touch $INSTALL_ROOT/etc/fstab

  # /etc/mtab is needed by udisks etc...
    ln -sf /proc/self/mounts $INSTALL_ROOT/etc/mtab

  mkdir -p $INSTALL_SYSTEM/bin
    cp $PKG_DIR/scripts/createlog $INSTALL_SYSTEM/bin/
    cp $PKG_DIR/scripts/lsb_release $INSTALL_SYSTEM/bin/
    ln -sf /bin/busybox $INSTALL_SYSTEM/bin/env          #/usr/bin/env is needed for most python scripts

  mkdir -p $INSTALL_SYSTEM/etc
    cp $PKG_DIR/config/profile $INSTALL_SYSTEM/etc
    cp $PKG_DIR/config/syslog.conf $INSTALL_SYSTEM/etc
    cp $PKG_DIR/config/httpd.conf $INSTALL_SYSTEM/etc
    echo "chmod 000 $INSTALL_SYSTEM/etc/shadow" >> $FAKEROOT_SCRIPT

  # /etc/fstab is needed by...
    touch $INSTALL_SYSTEM/etc/fstab

  # /etc/hosts must be writeable
    ln -sf /var/cache/hosts $INSTALL_SYSTEM/etc/hosts

  # /etc/mtab is needed by udisks etc...
    ln -sf /proc/self/mounts $INSTALL_SYSTEM/etc/mtab

  # create /etc/hostname
    ln -sf /proc/sys/kernel/hostname $INSTALL_SYSTEM/etc/hostname

  mkdir -p $INSTALL_SYSTEM/etc/modprobe.d
    cp $PKG_DIR/modprobe.d/* $INSTALL_SYSTEM/etc/modprobe.d

mkdir -p $INSTALL_ROOT/lib/splash
  if [ -f $PROJECT_DIR/$PROJECT/splash/splash.ppm ]; then
    cp $PROJECT_DIR/$PROJECT/splash/splash.ppm $INSTALL_ROOT/lib/splash
  else
    cp $PKG_DIR/splash/splash.ppm $INSTALL_ROOT/lib/splash
  fi

  # add user modprobe.d dir
    mkdir -p $INSTALL_SYSTEM/config/modprobe.d

  # add webroot
    mkdir -p $INSTALL_SYSTEM/www
      echo "It works" > $INSTALL_SYSTEM/www/index.html

    mkdir -p $INSTALL_SYSTEM/www/error
      echo "404" > $INSTALL_SYSTEM/www/error/404.html
